<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WasteBin: Het Gebruik van Meerdere ESP32-Microcontrollers met Node-Red</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="insyte-logo.jpg"/></td>
  <td id="projectalign">
   <div id="projectname">WasteBin<span id="projectnumber">&#160;Alpha</span>
   </div>
   <div id="projectbrief">Documentation on the WasteBin prototype project</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__io_t_oplossing.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Het Gebruik van Meerdere ESP32-Microcontrollers met Node-Red </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md13"></a>
Inleiding</h1>
<p >Meerdere ESP32-microcontrollers kunnen in combinatie met Node-Red worden gebruikt om een visuele interface te bouwen op basis van de gegevens die zijn gelogd door de ESP32. Elke ESP32 kan worden geconfigureerd om gegevens van een specifieke sensor of apparaat te loggen en deze via Wi-Fi naar Node-Red te verzenden. Node-Red kan vervolgens de gegevens ontvangen en verwerken met behulp van verschillende nodes.</p>
<h1><a class="anchor" id="autotoc_md14"></a>
Doelen</h1>
<h2><a class="anchor" id="autotoc_md15"></a>
Doel #1</h2>
<p >Het opzetten van een systeem waarbij meerdere ESP32-microcontrollers worden gebruikt om gegevens te loggen en deze naar Node-Red te verzenden voor visualisatie en verwerking.</p>
<h1><a class="anchor" id="autotoc_md16"></a>
Onderbouwing keuze ESP32 C3</h1>
<p >Wij kiezen voor een ESP32 omdat deze de volgende voordelen biedt:</p>
<ul>
<li>Relatief goedkoop (€2 per stuk).</li>
<li>Beschikbaarheid (1300 op voorraad bij Mouser, afhankelijk van het model).</li>
<li>Geschikt voor de taken die moeten worden uitgevoerd.</li>
<li>Compact formaat.</li>
</ul>
<h1><a class="anchor" id="autotoc_md17"></a>
Waarom geen Arduino of Raspberry Pi als computer voor de WasteBin?</h1>
<p >Raspberry Pi's zijn momenteel moeilijk verkrijgbaar, duur in aanschaf voor een testplatform en vereisen meer inspanning om op te zetten. Bovendien zijn ze vaak te krachtig voor onze doeleinden en daardoor overbodig qua rekenkracht. Arduino's zijn redelijke alternatieven, maar duurder dan losse ESP32-modules. Desalniettemin kunnen ESP32-modules via de Arduino IDE worden geprogrammeerd met behulp van de Arduino-codebibliotheken, indien gewenst.</p>
<h1><a class="anchor" id="autotoc_md18"></a>
Data forwarding</h1>
<p >Data forwarding is de plaats waar alle data van de ESP32's (of vuilnisbakken) wordt verzameld. Een mogelijke optie is het gebruik van specifieke hardware, zoals een Raspberry Pi met een broker (zoals Mosquitto) en een Node-Red-dashboard. Wij kiezen ervoor om de broker en het dashboard op onze lokale laptop te installeren in plaats van een Raspberry Pi te gebruiken. We hebben hiervoor meerdere redenen:</p>
<ol type="1">
<li>We vermijden de noodzaak van een extra apparaat (Raspberry Pi). Alles op één apparaat maakt het eenvoudiger. Bovendien zijn Raspberry Pi's moeilijk verkrijgbaar en vormen ze een extra bron van potentiële hardwarefouten (zoals SD-kaartcorruptie) en softwareproblemen (Linux-problemen) enzovoort.</li>
<li>Als we fysiek ergens anders willen werken, zouden we steeds de Raspberry Pi moeten verbinden met het netwerk op die locatie via een beeldscherm en toetsenbord.</li>
<li>De Raspberry Pi kan een beveiligingsrisico vormen.</li>
</ol>
<p >Stappen:</p>
<ol type="1">
<li>ESP32-gegevens laten versturen (verbinding maken met internet).</li>
<li>Opzetten van een MQTT-broker.</li>
<li>De MQTT-broker accepteert gegevens van de ESP32.</li>
<li>De MQTT-broker stuurt gegevens door naar Node-Red (lokaal).</li>
<li>Inkomende gegevens van de MQTT-broker worden omgezet naar een dashboardweergave.</li>
<li>Data van Node-Red doorsturen naar een database.</li>
</ol>
<h1><a class="anchor" id="autotoc_md19"></a>
De Data</h1>
<p >De volgende gegevens willen we versturen vanaf de ESP32:</p>
<ul>
<li>Temperatuur (dubbel)</li>
<li>Luchtvochtigheid (dubbel)</li>
<li>Klepstand (boolean)</li>
<li>Foutcodes (integer)</li>
<li>WasteBin-ID (macadres)</li>
</ul>
<p >Deze gegevens worden via MQTT naar Node-Red verzonden. Van daaruit worden de gegevens doorgestuurd naar een SQLite-database. We hebben gekozen voor SQLite vanwege de handige SQLiteStudio-omgeving waarin we de database gemakkelijk kunnen ontwerpen, opbouwen en testen.</p>
<h1><a class="anchor" id="autotoc_md20"></a>
Meldingen voor de gebruiker</h1>
<p >Voor onze opstelling willen we een luidspreker gebruiken als indicator die verschillende waarschuwingen kan afgeven wanneer dat nodig is. Deze waarschuwingen zijn onder andere:</p>
<ul>
<li>De klep staat te lang open (mogelijk)</li>
<li>De binnenkant van de bak is te warm (mogelijk klep open of slechte koeling)</li>
<li>Algemene fout (ander probleem)</li>
</ul>
<p >We hebben ervoor gekozen om deze waarschuwingen ook naar ons dashboard te sturen als ze zich voordoen. Deze waarschuwingen worden weergegeven als foutcodes.</p>
<h1><a class="anchor" id="autotoc_md21"></a>
Verstuur interval</h1>
<p >In principe worden alle gegevens elke 15 minuten verstuurd. We denken dat dit voldoende informatie is voor elke vuilnisbak om eventuele problemen te detecteren (bijvoorbeeld te lage temperatuur). Bovendien voorkomt dit dat de database overvol raakt met gegevens, vooral wanneer er 30 vuilnisbakken zijn.</p>
<h2><a class="anchor" id="autotoc_md22"></a>
In geval van fouten</h2>
<p >In geval van een fout wordt dit interval genegeerd. Het interval wordt dan 2 minuten, indien er zich één of meerdere fouten blijven voordoen.</p>
<h1><a class="anchor" id="autotoc_md23"></a>
Node-Red</h1>
<p >We zullen Node-Red gebruiken om alle gegevens van MQTT te ontvangen, te verwerken en weer te geven. Alle ontvangen informatie wordt weergegeven via een Node-Red UI-tabblad. Dit UI-tabblad, ook wel "dashboard" genoemd in Node-Red, is uitbreidbaar indien gewenst. Alle prototype vuilnisbakken kunnen in real-time worden weergegeven op het dashboard als dat gewenst is.</p>
<p >De Node-Red UI ziet er als volgt uit voor twee vuilnisbakken: <img src="node-red-ui.png" alt="Node-Red UI" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md24"></a>
Node-Red flow</h2>
<p >Om dit alles te laten werken, hebben we een Node-Red flow gemaakt. De Node-Red flow ziet er als volgt uit: <img src="node-red-setup.png" alt="Node-Red setup" class="inline"/></p>
<p >In deze flow ontvangt de eerste node (paars) de MQTT-gegevens. Vervolgens wordt er een tijdstempel aan het bericht toegevoegd en worden alle inkomende berichten gescheiden met behulp van een schakelaar (switch). De gegevens worden gescheiden op basis van het macadres (uniek) van de vuilnisbak.</p>
<p >Nadat de berichten zijn gescheiden, komen ze in een grote functieblok (oranje) dat het bericht analyseert en verdeelt over de uit puts van het functieblok. Ik heb hiervoor gekozen, zodat het functieblok modulair blijft en de uitvoer flexibel is. De uitvoer wordt gestuurd naar dashboardblokken (blauw) en naar nieuwe functieblokken die extra gegevens toevoegen (zoals sensor-ID) en deze als query naar een SQLite-database sturen.</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Database</h1>
<p >Alle informatie wordt via Node-Red doorgestuurd naar een SQLite-database. Het doel van de database is om een doorzoekbare geschiedenis van alle ontvangen gegevens van de vuilnisbakken te creëren en een overzicht te bieden van alle gebruikers (testpersonen) en hun gegevens.</p>
<p >De database is als volgt opgebouwd: <img src="WasteBinDBER.png" alt="Databaseontwerp" class="inline"/></p>
<p >Hierbij zijn alle onderstreepte woorden sleutelwaarden. Helaas toont het Database Entity Relationship-diagram (DBER) niet alle details, maar het geeft wel een goed overzicht van de databasestructuur.</p>
<p >De tabellen en relaties in de database zijn als volgt:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Tabelnaam   </th><th class="markdownTableHeadNone">Veldnaam   </th><th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Relatie    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Users   </td><td class="markdownTableBodyNone">UserID   </td><td class="markdownTableBodyNone">INTEGER   </td><td class="markdownTableBodyNone">PRIMARY KEY    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Name   </td><td class="markdownTableBodyNone">TEXT   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Email   </td><td class="markdownTableBodyNone">TEXT   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Phone   </td><td class="markdownTableBodyNone">TEXT   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">WasteBins   </td><td class="markdownTableBodyNone">WasteBinID   </td><td class="markdownTableBodyNone">INTEGER   </td><td class="markdownTableBodyNone">PRIMARY KEY    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Location   </td><td class="markdownTableBodyNone">TEXT   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">SensorID   </td><td class="markdownTableBodyNone">INTEGER   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">UserID   </td><td class="markdownTableBodyNone">INTEGER   </td><td class="markdownTableBodyNone">FOREIGN KEY    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SensorData   </td><td class="markdownTableBodyNone">SensorDataID   </td><td class="markdownTableBodyNone">INTEGER   </td><td class="markdownTableBodyNone">PRIMARY KEY    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">WasteBinID   </td><td class="markdownTableBodyNone">INTEGER   </td><td class="markdownTableBodyNone">FOREIGN KEY    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Timestamp   </td><td class="markdownTableBodyNone">TIMESTAMP   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Temperature   </td><td class="markdownTableBodyNone">REAL   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Humidity   </td><td class="markdownTableBodyNone">REAL   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">ValveStatus   </td><td class="markdownTableBodyNone">INTEGER   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">ErrorCode   </td><td class="markdownTableBodyNone">INTEGER   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SensorStatus   </td><td class="markdownTableBodyNone">SensorID   </td><td class="markdownTableBodyNone">INTEGER   </td><td class="markdownTableBodyNone">PRIMARY KEY    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Status   </td><td class="markdownTableBodyNone">TEXT   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">LastUpdated   </td><td class="markdownTableBodyNone">TIMESTAMP   </td><td class="markdownTableBodyNone"></td></tr>
</table>
<p >Dit is de tabelstructuur voor de database, waarbij elke tabel de bijbehorende velden en datatypes bevat. De tabelrelaties zijn aangegeven met "PRIMARY KEY" en "FOREIGN KEY" om de verbanden tussen de tabellen weer te geven.</p>
<p >De database kan worden doorzocht met behulp van "views" in SQLiteStudio. Deze kunnen door de gebruiker worden gemaakt en aangepast.</p>
<p >Dit is een overzicht van de opzet voor het gebruik van meerdere ESP32-microcontrollers met Node-Red. Met deze configuratie kunnen we gegevens loggen van verschillende sensoren of apparaten, deze visualiseren op een dashboard en ze opslaan in een database voor verdere analyse en beheer. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
